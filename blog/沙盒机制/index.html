<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://c3n1gbr0k3n.github.io/main.e883366e4b577741d201cac65bcdebd71c66d657832b99dd31c1ee69f72fd2925eb4a4bde47bd2610347501b510ea21b2b055f091f79150ba409c0ae3ae0a9d2.css integrity="sha512-6IM2bktXd0HSAcrGW83r1xxm1leDK5ndMcHuafcv0pJetKS95HvSYQNHUBtRDqIbKwVfCR95FQukCcCuOuCp0g==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>沙盒机制 - BinaryMusings</title><meta name=description content="0x01 介绍 # 沙盒是计算机领域的虚拟技术，一般会将不信任的软件放入沙盒中运行，如果检测到软件的违规行为就会禁止程序进一步执行。这里的沙盒机制是针对于pwn题，由于程序运行最后都会通过系统调用来调用硬件资源，所以我们可以监控程序调用了哪些系统调用。如果程序执行了一些系统调用比如execve等，则直接end。 实现禁用系统调用的方法有两种，一种是通过prctl系统调用，还有一种是seccomp库
prctl系统调用 # 它的函数原型为
#include&amp;lt;sys/prctl.h&amp;gt; int prctl(int option, unsigned long arg2, unsigned long arg3, unsigned long arg4, unsigned long arg5); option：要执行的操作标志 arg2、arg3、arg4、arg5：根据不同的操作标志有不同的参数 返回值：执行成功返回0，执行失败返回-1 option的值有很多，具体的可以查看Linux手册，这里比较常用的是PR_SET_NO_NEW_PRIVS（38）限制了新程序的特权，使其不能超过原程序的特权，只需要设置arg2为1即可
int prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0); 还有一个值是PR_SET_SECCOMP（22），如果arg2为1的话，则表示只开启read、write、exit和sigreturn这几个系统调用。如果arg2为2的话则表示为过滤模式，主要根据arg2来过滤东西，arg2是一个struct sock_fprog类型指针，该结构体原型为
#include&amp;lt;linux/filter.h&amp;gt; struct sock_fprog { unsigned short len; struct sock_filter *filter; }; len：表示过滤器个数 filter：指向过滤器的指针，指向sock_filter数组 sock_filter结构体原型为
struct sock_filter { /* Filter block */ __u16 code; /* Actual filter code */ __u8 jt; /* Jump true */ __u8 jf; /* Jump false */ __u32 k; /* Generic multiuse field */ }; code：指令码，即该指令的操作类型和参数类型 jt：表示跳转条件，即如果该指令的操作结果为真，应该跳转到哪个指令执行 jf：表示跳转条件，即如果该指令的操作结果为假，应该跳转到哪个指令执行 k：表示参数，即该指令的操作参数 常见的code有"><link rel=canonical href=https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="沙盒机制"><meta property="og:description" content="0x01 介绍 # 沙盒是计算机领域的虚拟技术，一般会将不信任的软件放入沙盒中运行，如果检测到软件的违规行为就会禁止程序进一步执行。这里的沙盒机制是针对于pwn题，由于程序运行最后都会通过系统调用来调用硬件资源，所以我们可以监控程序调用了哪些系统调用。如果程序执行了一些系统调用比如execve等，则直接end。 实现禁用系统调用的方法有两种，一种是通过prctl系统调用，还有一种是seccomp库
prctl系统调用 # 它的函数原型为
#include<sys/prctl.h> int prctl(int option, unsigned long arg2, unsigned long arg3, unsigned long arg4, unsigned long arg5); option：要执行的操作标志 arg2、arg3、arg4、arg5：根据不同的操作标志有不同的参数 返回值：执行成功返回0，执行失败返回-1 option的值有很多，具体的可以查看Linux手册，这里比较常用的是PR_SET_NO_NEW_PRIVS（38）限制了新程序的特权，使其不能超过原程序的特权，只需要设置arg2为1即可
int prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0); 还有一个值是PR_SET_SECCOMP（22），如果arg2为1的话，则表示只开启read、write、exit和sigreturn这几个系统调用。如果arg2为2的话则表示为过滤模式，主要根据arg2来过滤东西，arg2是一个struct sock_fprog类型指针，该结构体原型为
#include<linux/filter.h> struct sock_fprog { unsigned short len; struct sock_filter *filter; }; len：表示过滤器个数 filter：指向过滤器的指针，指向sock_filter数组 sock_filter结构体原型为
struct sock_filter { /* Filter block */ __u16 code; /* Actual filter code */ __u8 jt; /* Jump true */ __u8 jf; /* Jump false */ __u32 k; /* Generic multiuse field */ }; code：指令码，即该指令的操作类型和参数类型 jt：表示跳转条件，即如果该指令的操作结果为真，应该跳转到哪个指令执行 jf：表示跳转条件，即如果该指令的操作结果为假，应该跳转到哪个指令执行 k：表示参数，即该指令的操作参数 常见的code有"><meta property="og:url" content="https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/"><meta property="og:site_name" content="BinaryMusings"><meta property="article:published_time" content="2023-05-21T09:38:21+08:00"><meta property="article:modified_time" content="2023-05-21T09:38:21+08:00"><meta property="og:image" content="https://c3n1gbr0k3n.github.io/doks.png"><meta property="og:image:alt" content="BinaryMusings"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="沙盒机制"><meta name=twitter:description content><meta name=twitter:image content="https://c3n1gbr0k3n.github.io/doks.png"><meta name=twitter:image:alt content="沙盒机制"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1","name":"Doks","url":"https://c3n1gbr0k3n.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://c3n1gbr0k3n.github.io/#/schema/image/1","url":"https://c3n1gbr0k3n.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://c3n1gbr0k3n.github.io/#/schema/website/1","url":"https://c3n1gbr0k3n.github.io/","name":"BinaryMusings","description":"二进制随想录，分享与开放","publisher":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/","url":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/","name":"沙盒机制","description":"","isPartOf":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/website/1"},"about":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"},"datePublished":"2023-05-21T09:38:21CET","dateModified":"2023-05-21T09:38:21CET","breadcrumb":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/"]}]},{"@type":"BreadcrumbList","@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/","url":"https://c3n1gbr0k3n.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/blog/","url":"https://c3n1gbr0k3n.github.io/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://c3n1gbr0k3n.github.io/#/schema/article/1","headline":"沙盒机制","description":"","isPartOf":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/"},"mainEntityOfPage":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/"},"datePublished":"2023-05-21T09:38:21CET","dateModified":"2023-05-21T09:38:21CET","author":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/person/2"},"publisher":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"},"image":{"@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://c3n1gbr0k3n.github.io/#/schema/person/2","name":"Henk Verlinde","sameAs":["https://twitter.com/henkverlinde","https://www.linkedin.com/in/henkverlinde/","https://github.com/h-enk"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://c3n1gbr0k3n.github.io/blog/%E6%B2%99%E7%9B%92%E6%9C%BA%E5%88%B6/#/schema/image/2","url":"https://c3n1gbr0k3n.github.io/doks.png","contentUrl":"https://c3n1gbr0k3n.github.io/doks.png","caption":"沙盒机制"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://c3n1gbr0k3n.github.io/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://c3n1gbr0k3n.github.io/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://c3n1gbr0k3n.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://c3n1gbr0k3n.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://c3n1gbr0k3n.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://c3n1gbr0k3n.github.io/site.webmanifest></head><body class="blog single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=https://c3n1gbr0k3n.github.io/ aria-label=BinaryMusings>BinaryMusings</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://c3n1gbr0k3n.github.io/>BinaryMusings</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://c3n1gbr0k3n.github.io/writeup/buuoj/warmup_csaw_2016>WriteUp</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://c3n1gbr0k3n.github.io/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/c3n1gbr0k3n/BinaryMusings><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>沙盒机制</h1><p><small>Posted&nbsp;on&nbsp;May 21, 2023 by &nbsp;&dash;&nbsp;<strong>2&nbsp;min read</strong></small><p></div></div><div class=col-md-13><div></div></div><div class="col-md-12 col-lg-9"><h2 id=0x01-介绍>0x01 介绍 <a href=#0x01-%e4%bb%8b%e7%bb%8d class=anchor aria-hidden=true>#</a></h2><p>沙盒是计算机领域的虚拟技术，一般会将不信任的软件放入沙盒中运行，如果检测到软件的违规行为就会禁止程序进一步执行。这里的沙盒机制是针对于pwn题，由于程序运行最后都会通过系统调用来调用硬件资源，所以我们可以监控程序调用了哪些系统调用。如果程序执行了一些系统调用比如execve等，则直接end。
实现禁用系统调用的方法有两种，一种是通过prctl系统调用，还有一种是seccomp库</p><h3 id=prctl系统调用>prctl系统调用 <a href=#prctl%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 class=anchor aria-hidden=true>#</a></h3><p>它的函数原型为</p><pre><code class=language-c>#include&lt;sys/prctl.h&gt;
int prctl(int option, unsigned long arg2, unsigned long arg3, unsigned long arg4, unsigned long arg5);
</code></pre><ul><li>option：要执行的操作标志</li><li>arg2、arg3、arg4、arg5：根据不同的操作标志有不同的参数</li><li>返回值：执行成功返回0，执行失败返回-1</li></ul><p>option的值有很多，具体的可以查看<a href=https://man7.org/linux/man-pages/man2/prctl.2.html>Linux手册</a>，这里比较常用的是<code>PR_SET_NO_NEW_PRIVS</code>（38）限制了新程序的特权，使其不能超过原程序的特权，只需要设置arg2为1即可</p><pre><code class=language-c>int prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);
</code></pre><p>还有一个值是PR_SET_SECCOMP（22），如果arg2为1的话，则表示只开启read、write、exit和sigreturn这几个系统调用。如果arg2为2的话则表示为过滤模式，主要根据arg2来过滤东西，arg2是一个<code>struct sock_fprog</code>类型指针，该结构体原型为</p><pre><code class=language-c>#include&lt;linux/filter.h&gt;

struct sock_fprog {
    unsigned short      len;
    struct sock_filter *filter;
};
</code></pre><ul><li>len：表示过滤器个数</li><li>filter：指向过滤器的指针，指向sock_filter数组</li></ul><p>sock_filter结构体原型为</p><pre><code class=language-c>struct sock_filter {    /* Filter block */
        __u16   code;   /* Actual filter code */
        __u8    jt;     /* Jump true */
        __u8    jf;     /* Jump false */
        __u32   k;      /* Generic multiuse field */
};
</code></pre><ul><li>code：指令码，即该指令的操作类型和参数类型</li><li>jt：表示跳转条件，即如果该指令的操作结果为真，应该跳转到哪个指令执行</li><li>jf：表示跳转条件，即如果该指令的操作结果为假，应该跳转到哪个指令执行</li><li>k：表示参数，即该指令的操作参数</li></ul><p>常见的code有</p><ul><li>BPF_LD：加载数据</li><li>BPF_ABS：偏移</li><li>BPF_JMP：跳转到指定的指令执行</li><li>BPF_RET：返回结果并结束过滤</li><li>BPF_W：4个字节</li><li>BPF_H：2个字节</li><li>BPF_B：1个字节</li><li>BPF_K：常数</li></ul><p>为了方便编写规则，BPF提供了两个比较容易使用的宏在<code>/usr/include/linux/bpf_common.h</code>文件中</p><pre><code class=language-c>#ifndef BPF_STMT
#define BPF_STMT(code, k) { (unsigned short)(code), 0, 0, k }
#endif
#ifndef BPF_JUMP
#define BPF_JUMP(code, k, jt, jf) { (unsigned short)(code), jt, jf, k }
#endif
</code></pre><p>BPF_STMT针对于读取返回指令设置的，BPF_JUMP则是针对于跳转指令。我们尝试写一个过滤规则</p><pre><code class=language-c>#include &lt;linux/seccomp.h&gt;
#include&lt;linux/filter.h&gt;

struct sock_filter filter[] = {
    BPF_STMT(BPF_LD | BPF_W | BPF_ABS, 0),
    BPF_JUMP(BPF_JMP | BPF_JEQ, __NR_read, 1, 0),
    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),
    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL),
}
</code></pre><p>第一条过滤规则为BPF_LD读取BPF_W四个字节BPF_ABS从帧偏移量为0处，也就是将系统调用号存入累加器中
第二条规则为BPF_JEQ判断累加器即系统调用号是否等于read的系统调用号，如果为true则BPF_JMP一条指令，即执行第四条规则，否则BPF_JMP零条指令，即执行第三条规则
第三条规则为BPF_RET返回BPF_K常量值SECCOMP_RET_ALLOW即运行执行
第四条规则为BPF_RET返回BPF_K常量值SECCOMP_RET_KILL即拒绝运行
过滤规则这部分可以参考<a href=https://www.kernel.org/doc/html/latest/networking/filter.html>Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a>
写一个具体的例子来看</p><pre><code class=language-c>#include &lt;unistd.h&gt;
#include &lt;asm/unistd.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;linux/seccomp.h&gt;
#include &lt;linux/filter.h&gt;

int main(int argc, char *argv[]) {
    struct sock_filter filter[] = {
        BPF_STMT(BPF_LD | BPF_W | BPF_ABS, 0),
        BPF_JUMP(BPF_JMP | BPF_JEQ, __NR_write, 1, 0),
        BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),
        BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL)
    };
    struct sock_fprog fprog = {
        .len = sizeof(filter)/sizeof(filter[0]),
        .filter = filter,
    };
    prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);
    prctl(PR_SET_SECCOMP, 2, &amp;fprog, 0, 0);
    syscall(__NR_write, 1, &quot;hello\n&quot;, 6);
    return 0;
}
// gcc prctl_test.c -o prctl_test
</code></pre><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/3d1433bc1ec644e4da8d29d0a21ccbff.png alt=3d1433bc1ec644e4da8d29d0a21ccbff></p><h3 id=seccomp库>Seccomp库 <a href=#seccomp%e5%ba%93 class=anchor aria-hidden=true>#</a></h3><p>它用起来比prctl更方便，但是需要安装部分库</p><pre><code class=language-bash>sudo apt-get install libseccomp-dev libseccomp2 seccomp
</code></pre><p>可以写一个简单的例子来看一下使用方法</p><pre><code class=language-c>#include &lt;linux/seccomp.h&gt;
#include &lt;seccomp.h&gt;
#include &lt;unistd.h&gt;

int main() {
    // 初始化过滤器
    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW);

    // 添加一条过滤规则，禁用 write 系统调用
    seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(write), 0);

    // 加载 seccomp 过滤器
    seccomp_load(ctx);
    syscall(__NR_write, 1, &quot;hello\n&quot;, 6);
    return 0;
}
// gcc sccomp_test.c -o seccomp_test -lseccomp
// 编译的时候需要指定库即 -lseccomp
</code></pre><p>scmp_filter_ctx是过滤器的结构体，所有的过滤信息都保存在里面
seccomp_init是初始化结构体，它可以初始化过滤器为白名单模式和黑名单模式，SCMP_ACT_KILL即白名单模式，只有在规则里的系统调用才会被允许执行；SCMP_ACT_ALLOW即黑名单模式，在规则里的系统调用会被禁用
seccomp_rule_add是添加规则，第二个参数是指这条规则匹配后要做的操作，SCMP_ACT_ERRNO表示在匹配后报一个特殊的错误，也可以直接填为SCMP_ACT_KILL，即直接kill，第三个参数是系统调用号，第四个参数是对目标系统调用的参数做出限制，这里由于是直接禁用该系统调用，所以填0即可
seccomp_load是加载过滤器</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/e3f02893e2e39754c56d2c15a1aaf1aa.png alt=e3f02893e2e39754c56d2c15a1aaf1aa></p><h2 id=0x02-参考文章>0x02 参考文章 <a href=#0x02-%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 class=anchor aria-hidden=true>#</a></h2><p>https://bbs.kanxue.com/thread-258146.htm</p></div></div></article></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Written by c3n1gbr0k3n</li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://c3n1gbr0k3n.github.io/js/bootstrap.min.650aeec64c81d69d4c0850fc73c93da3f0330cec0a27772feed7f90f60baa5f47f1c45687d71914bdafd1c4e860d40f6dc08ede27a2f08431ff929c9a2d24621.js integrity="sha512-ZQruxkyB1p1MCFD8c8k9o/AzDOwKJ3cv7tf5D2C6pfR/HEVofXGRS9r9HE6GDUD23Ajt4novCEMf+SnJotJGIQ==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/js/highlight.min.a5eee34927239a22fbeae000257a46e9983ab5860c2401ddcdb32664d8e92accdb1b58a4ced97109bc642ef870a90fd4b4e916f4f98205a6008bd257ad49e9a4.js integrity="sha512-pe7jSScjmiL76uAAJXpG6Zg6tYYMJAHdzbMmZNjpKszbG1ikztlxCbxkLvhwqQ/UtOkW9PmCBaYAi9JXrUnppA==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/main.min.cb2e2ebbf2e4002f3117addc33582923b2b3ae5265c22944cd117ebec7abe61c170417c4506d7a0f8f0fc9053dfdf441421d53601ac467042ff3d06ec0ba07fa.js integrity="sha512-yy4uu/LkAC8xF63cM1gpI7KzrlJlwilEzRF+vser5hwXBBfEUG16D48PyQU9/fRBQh1TYBrEZwQv89BuwLoH+g==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/index.min.5575bab782564729398c400507a85be5230867008a1c3247256457d9d9af13ba5758ed38a849b0385561691cd755fb1d6397ab7001c9fba02d81eba1ef80cbbb.js integrity="sha512-VXW6t4JWRyk5jEAFB6hb5SMIZwCKHDJHJWRX2dmvE7pXWO04qEmwOFVhaRzXVfsdY5ercAHJ+6Atgeuh74DLuw==" crossorigin=anonymous defer></script></body></html>